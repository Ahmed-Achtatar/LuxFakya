<!DOCTYPE html>
<html lang="{{ current_lang }}" dir="{{ text_dir }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <title>LuxFakya - {{ get_text('hero_slide1_title') }}</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    {% if text_dir == 'rtl' %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    {% else %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    {% endif %}

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <!-- AOS Animation CSS -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    {% block extra_css %}{% endblock %}
</head>
<body class="d-flex flex-column min-vh-100">
    <!-- Promo Banner -->
    <div class="fixed-top bg-gold text-white text-center py-2 small fw-bold" style="z-index: 1060; height: 35px;">
        {% if remaining_amount <= 0 %}
            <i class="fas fa-truck me-2"></i> {{ get_text('promo_free_shipping') }}
        {% else %}
            <i class="fas fa-truck me-2"></i> {{ get_text('promo_add_more').replace('{amount}', "%.2f"|format(remaining_amount)) }}
        {% endif %}
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark fixed-top {% if request.endpoint == 'main.index' %}navbar-transparent{% else %}bg-dark-scrolled{% endif %} transition-all" id="mainNavbar" style="top: 35px;">
        <div class="container-fluid px-lg-5 position-relative">
            <!-- Mobile Toggle (Start) -->
            <button class="d-lg-none btn border-0 text-white p-0 me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu" aria-controls="mobileMenu">
                <i class="fas fa-bars fa-lg"></i>
            </button>

            <!-- Mobile Logo (Center) -->
            <a class="navbar-brand d-lg-none mx-auto" href="{{ url_for('main.index') }}">
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="LuxFakya" style="height: 110px; width: auto;">
            </a>

            <!-- Mobile Icons (End) -->
             <div class="d-flex d-lg-none align-items-center gap-3">
                 <a class="position-relative text-white" href="{{ url_for('main.cart') }}">
                    <i class="fas fa-shopping-bag"></i>
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-gold {% if not session.get('cart') %}d-none{% endif %}" style="font-size: 0.5rem;">
                        {{ session.get('cart')|length if session.get('cart') else 0 }}
                    </span>
                </a>

                <!-- Mobile Icons (End) -->
                 <div class="d-flex d-lg-none align-items-center gap-3">
                     <a class="position-relative text-white" href="{{ url_for('main.cart') }}">
                        <i class="fas fa-shopping-bag"></i>
                        {% if session.get('cart') %}
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-gold" style="font-size: 0.5rem;">
                            {{ session.get('cart')|length }}
                        </span>
                        {% endif %}
                    </a>
                 </div>

                <div class="collapse navbar-collapse justify-content-between align-items-center d-none d-lg-flex" id="navbarContent">
                    <!-- Start Nav: Menu Links -->
                    <ul class="navbar-nav mb-2 mb-lg-0">
                         <li class="nav-item"><a class="nav-link" href="{{ url_for('main.index') }}"><i class="fas fa-home d-none d-lg-inline-block"></i><span class="d-lg-none">{{ get_text('home') }}</span></a></li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                {{ get_text('categories') }}
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                                {% for cat in all_categories %}
                                <li><a class="dropdown-item" href="{{ url_for('main.shop', category=cat.name) }}">{{ cat.name }}</a></li>
                                {% endfor %}
                            </ul>
                        </li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('main.shop') }}">{{ get_text('shop') }}</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('main.about') }}">{{ get_text('about_us') }}</a></li>
                    </ul>

                    <!-- Center Logo (Desktop) -->
                    <a class="navbar-brand d-none d-lg-block navbar-brand-center" href="{{ url_for('main.index') }}">
                        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="LuxFakya" style="height: 120px; width: auto;">
                    </a>

                    <!-- End Nav: Icons -->
                    <ul class="navbar-nav mb-2 mb-lg-0 align-items-center">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle text-uppercase" href="#" id="langDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                {{ current_lang }}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="langDropdown" style="min-width: auto;">
                                <li><a class="dropdown-item" href="{{ url_for('main.set_lang', lang_code='fr') }}">FR</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('main.set_lang', lang_code='ar') }}">AR</a></li>
                            </ul>
                        </div>
                        {% else %}
                        <a class="nav-link" href="{{ url_for('auth.login') }}"><i class="fas fa-user"></i></a>
                        {% endif %}
                    </li>
                    <li class="nav-item">
                        <a class="nav-link position-relative" href="{{ url_for('main.cart') }}">
                            <i class="fas fa-shopping-bag"></i>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-gold {% if not session.get('cart') %}d-none{% endif %}" style="font-size: 0.6rem;">
                                {{ session.get('cart')|length if session.get('cart') else 0 }}
                            </span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <main class="flex-grow-1">
            {% if request.endpoint != 'main.index' %}
            <div class="container page-content-spacer">
            {% endif %}

            {% block content %}{% endblock %}

            {% if request.endpoint != 'main.index' %}
            </div>
            {% endif %}
        </main>

        <footer>
            <div class="container">
                <div class="row">
                    <!-- Categories -->
                    <div class="col-md-6 mb-4">
                        <h5 class="fw-bold mb-3 font-serif">{{ get_text('footer_categories') }}</h5>
                        <ul class="list-unstyled footer-links">
                            {% for cat in all_categories %}
                            <li><a href="{{ url_for('main.shop', category=cat.name) }}">{{ cat.name }}</a></li>
                            {% endfor %}
                        </ul>
                    </div>

                    <!-- Contact Us -->
                    <div class="col-md-6 mb-4">
                        <h5 class="fw-bold mb-3 font-serif">{{ get_text('footer_contact') }}</h5>
                        <ul class="list-unstyled footer-links">
                            <li class="mb-2"><a href="https://maps.app.goo.gl/nmxA4nULtmBbrmPS6" target="_blank" class="text-reset text-decoration-none"><i class="fas fa-map-marker-alt me-2"></i>{{ get_text('address_val') }}</a></li>
                            <li class="mb-2"><a href="https://maps.app.goo.gl/nmxA4nULtmBbrmPS6" target="_blank" class="text-gold fw-bold"><i class="fas fa-map me-2"></i>{{ get_text('location_label') }}</a></li>
                            <li><a href="tel:+212676459945"><i class="fas fa-phone me-2"></i><span class="force-ltr">+212 676 459 945</span></a></li>
                            <li><a href="https://wa.me/212676459945" target="_blank"><i class="fab fa-whatsapp me-2"></i>WhatsApp</a></li>
                            <li><a href="mailto:luxfakya@gmail.com"><i class="fas fa-envelope me-2"></i>luxfakya@gmail.com</a></li>
                        </ul>
                    </div>
                </div>

            </div>
        </footer>
    </div>

    <!-- Mobile Offcanvas Menu -->
    <div class="offcanvas offcanvas-start bg-dark text-white" tabindex="-1" id="mobileMenu">
        <div class="offcanvas-header border-bottom border-secondary">
            <form action="{{ url_for('main.shop') }}" method="get" class="d-flex flex-grow-1 me-3">
                <div class="input-group">
                    <input type="text" name="q" class="form-control bg-transparent text-white border-secondary" placeholder="{{ get_text('search_placeholder') }}" aria-label="Search">
                    <button class="btn btn-outline-secondary text-gold border-secondary" type="submit">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </form>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="d-flex justify-content-end mb-3">
                 <a href="{{ url_for('main.set_lang', lang_code='fr') }}" class="btn btn-sm {% if current_lang == 'fr' %}btn-gold{% else %}btn-outline-light{% endif %} me-2">FR</a>
                 <a href="{{ url_for('main.set_lang', lang_code='ar') }}" class="btn btn-sm {% if current_lang == 'ar' %}btn-gold{% else %}btn-outline-light{% endif %}">AR</a>
            </div>
            <ul class="navbar-nav flex-column">
                <li class="nav-item"><a class="nav-link" href="{{ url_for('main.index') }}">{{ get_text('home') }}</a></li>
                <li class="nav-item">
                    <a class="nav-link d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#mobileCategories" role="button" aria-expanded="false" aria-controls="mobileCategories">
                        {{ get_text('categories') }} <i class="fas fa-chevron-down small"></i>
                    </a>
                    <div class="collapse ps-3" id="mobileCategories">
                        <ul class="navbar-nav">
                            {% for cat in all_categories %}
                            <li><a class="nav-link py-1" href="{{ url_for('main.shop', category=cat.name) }}">{{ cat.name }}</a></li>
                            {% endfor %}
                        </ul>
                    </div>
                </li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('main.shop') }}">{{ get_text('shop') }}</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('main.about') }}">{{ get_text('about_us') }}</a></li>
            </ul>

            <hr class="border-secondary my-4">

            <div class="d-flex flex-column gap-3">
                {% if not current_user.is_authenticated %}
                <a href="{{ url_for('auth.login') }}" class="btn btn-outline-light w-100 rounded-pill">{{ get_text('login_register') }}</a>
                {% else %}
                    {% if current_user.role == 'admin' %}
                    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-light w-100 rounded-pill">Dashboard</a>
                    {% else %}
                    <a href="{{ url_for('auth.profile') }}" class="btn btn-outline-light w-100 rounded-pill">Profile</a>
                    {% endif %}
                <a href="{{ url_for('auth.logout') }}" class="btn btn-gold w-100 rounded-pill">{{ get_text('logout') }}</a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1055;">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="toast align-items-center text-white bg-{{ 'success' if category == 'success' else 'danger' if category == 'error' else 'primary' }} border-0 shadow-lg mb-2" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
                    <div class="d-flex">
                        <div class="toast-body fs-6">
                            {% if category == 'success' %}<i class="fas fa-check-circle me-2"></i>{% endif %}
                            {{ message }}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    </div>

    <!-- Floating Widget -->
    <div class="floating-widget d-flex flex-column gap-3">
        <a href="https://wa.me/212676459945" target="_blank" class="widget-btn whatsapp-btn shadow-lg d-flex align-items-center justify-content-center text-white text-decoration-none">
            <i class="fab fa-whatsapp fa-2x"></i>
        </a>
        <a href="{{ url_for('main.cart') }}" class="widget-btn cart-btn shadow-lg d-flex align-items-center justify-content-center text-white text-decoration-none position-relative">
            <i class="fas fa-shopping-bag fa-lg"></i>
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger border border-light {% if not session.get('cart') %}d-none{% endif %}" style="font-size: 0.7rem;">
                {{ session.get('cart')|length if session.get('cart') else 0 }}
            </span>
        </a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- AOS Animation JS -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <script>
        // Initialize AOS
        AOS.init({
            duration: 800,
            once: true,
            offset: 50
        });

        // Initialize Toasts
        var toastElList = [].slice.call(document.querySelectorAll('.toast'))
        var toastList = toastElList.map(function (toastEl) {
            var toast = new bootstrap.Toast(toastEl)
            toast.show()
            return toast
        })

        // Navbar Scroll Effect
        const navbar = document.getElementById('mainNavbar');
        window.addEventListener('scroll', function() {
            if (window.scrollY > 50) {
                navbar.classList.add('bg-dark-scrolled');
                navbar.classList.remove('navbar-transparent');
                navbar.classList.add('shadow');
            } else {
                {% if request.endpoint == 'main.index' %}
                navbar.classList.remove('bg-dark-scrolled');
                navbar.classList.add('navbar-transparent');
                navbar.classList.remove('shadow');
                {% endif %}
            }
        });

        // AJAX Cart Handling
        document.addEventListener('submit', function(e) {
            if (e.target.tagName === 'FORM' && e.target.action.includes('/cart/add/')) {
                e.preventDefault();
                const form = e.target;
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;

                // Disable button
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                fetch(form.action, {
                    method: 'POST',
                    body: new FormData(form),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Update Cart Badge
                        const cartBadges = document.querySelectorAll('.fa-shopping-bag + .badge');
                        cartBadges.forEach(badge => {
                            badge.textContent = data.cart_count;
                            badge.classList.remove('d-none');
                        });

                        // Badge updated via class removal

                        showToast(data.message, 'success');
                    } else {
                        showToast('Error adding to cart', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('An error occurred', 'danger');
                })
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                });
            }
        });

        function showToast(message, type = 'success') {
            const toastContainer = document.querySelector('.toast-container');
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type === 'error' ? 'danger' : type} border-0 shadow-lg mb-2" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body fs-6">
                            ${type === 'success' ? '<i class="fas fa-check-circle me-2"></i>' : ''}
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const newToastEl = toastContainer.lastElementChild;
            const toast = new bootstrap.Toast(newToastEl);
            toast.show();

            // Remove after hidden
            newToastEl.addEventListener('hidden.bs.toast', () => {
                newToastEl.remove();
            });
        }
    </script>
</body>
</html>
